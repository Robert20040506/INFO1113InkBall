<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>App.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">inkball_scaffold</a> &gt; <a href="index.source.html" class="el_package">inkball</a> &gt; <span class="el_source">App.java</span></div><h1>App.java</h1><pre class="source lang-java linenums">package inkball;

import processing.core.PApplet;
import processing.core.PGraphics;
import processing.core.PImage;
import processing.core.PVector;
import processing.data.JSONArray;
import processing.data.JSONObject;
import processing.event.KeyEvent;
import processing.event.MouseEvent;

import java.io.BufferedReader;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.IOException;
import java.util.*;

/**
 * The main class for the InkBall game application.
 */
public class App extends PApplet {
    public static App instance;

    // Constants
    public static final int CELL_SIZE = 32;
    public static final int TOP_BAR_HEIGHT = 64;
    public static final int BOARD_SIZE = 18;
    public static final int FPS = 30;
    public static final int WIDTH = CELL_SIZE * BOARD_SIZE;
    public static final int HEIGHT = WIDTH + TOP_BAR_HEIGHT;

    // Game configuration
    public String configPath;

    // Game state variables
    public GameState gameState;
    public boolean ctrlPressed;
    public boolean drawing;
    public boolean levelLoaded;
    public boolean draw;

    // Game data
    public int currentLevel;
    public int currentScore;
    public int previousScore;
    public int levelTime;
    public int levelFrames;
    public float spawnTime;
    public int spawnFrames;
    public int spawnInterval;
    public float scoreIncreaseModifier;
    public float scoreDecreaseModifier;

    // Game objects
    public String layout;
    public List&lt;Level&gt; levels;
    public Queue&lt;String&gt; ballsInQueue;
    public List&lt;Ball&gt; ballsOnScreen;
    public List&lt;Spawner&gt; spawners;
    public List&lt;Ball&gt; ballsToBeRemoved;
    public List&lt;List&lt;PVector&gt;&gt; lines;
    public List&lt;PVector&gt; currentLine;

    // Images
    public List&lt;PImage&gt; ballImages;
    public List&lt;PImage&gt; wallImages;
    public List&lt;PImage&gt; holeImages;
    public PImage normalTileImage;
    public PImage spawnerImage;
    public List&lt;PImage&gt; verticalColorWallImages;
    public List&lt;PImage&gt; horizontalColorWallImages;

    // Graphics layers
    public PGraphics boardLayer;
    public PGraphics levelCompletionLayer;
    public PGraphics ballLayer;
    public PGraphics topBarLayer;
    public PGraphics conveyorBeltLayer;
    public PGraphics lineLayer;

    // Board
    public Tile[][] board;

    // Static maps for score calculations
    public static Map&lt;String, Integer&gt; scoreIncreaseMap;
    public static Map&lt;String, Integer&gt; scoreDecreaseMap;

    // Random number generator
<span class="fc" id="L89">    public static final Random RANDOM = new Random();</span>

    /**
     * Enum representing the game state.
     */
<span class="fc" id="L94">    public enum GameState {</span>
<span class="fc" id="L95">        RUNNING,</span>
<span class="fc" id="L96">        PAUSED,</span>
<span class="fc" id="L97">        LEVEL_COMPLETE,</span>
<span class="fc" id="L98">        GAME_ENDED,</span>
<span class="fc" id="L99">        LEVEL_COMPLETION_ANIMATION,</span>
<span class="fc" id="L100">        LEVEL_TIME_UP</span>
    }

    /**
     * Constructor for the App class.
     */
<span class="fc" id="L106">    public App() {</span>
<span class="fc" id="L107">        instance = this;</span>
<span class="fc" id="L108">        this.configPath = &quot;config.json&quot;;</span>
<span class="fc" id="L109">        this.currentLevel = 1;</span>
<span class="fc" id="L110">        this.gameState = GameState.RUNNING;</span>
<span class="fc" id="L111">    }</span>

<span class="fc" id="L113">    public static App getInstance() { return instance; }</span>
<span class="fc" id="L114">    public static void setInstance(App instance) { App.instance = instance; }</span>

    /**
     * Initializes the settings of the window size.
     */
    @Override
    public void settings() {
<span class="fc" id="L121">        size(WIDTH, HEIGHT);</span>
<span class="fc" id="L122">    }</span>

    /**
     * Loads resources and initializes game elements.
     */
    @Override
    public void setup() {
<span class="fc" id="L129">        frameRate(FPS);</span>
<span class="fc" id="L130">        loadConfig(configPath);</span>
<span class="fc" id="L131">        loadImages();</span>
<span class="fc" id="L132">        initializeLayers();</span>
<span class="fc" id="L133">        initializeGameVariables();</span>
<span class="fc" id="L134">    }</span>

    /**
     * Initializes graphics layers.
     */
    public void initializeLayers() {
<span class="fc" id="L140">        boardLayer = createGraphics(WIDTH, WIDTH);</span>
<span class="fc" id="L141">        levelCompletionLayer = createGraphics(WIDTH, WIDTH);</span>
<span class="fc" id="L142">        ballLayer = createGraphics(WIDTH, WIDTH);</span>
<span class="fc" id="L143">        topBarLayer = createGraphics(WIDTH, TOP_BAR_HEIGHT);</span>
<span class="fc" id="L144">        conveyorBeltLayer = createGraphics(162, 40);</span>
<span class="fc" id="L145">        lineLayer = createGraphics(WIDTH, WIDTH);</span>
<span class="fc" id="L146">    }</span>

    /**
     * Initializes game variables.
     */
    public void initializeGameVariables() {
<span class="fc" id="L152">        ctrlPressed = false;</span>
<span class="fc" id="L153">        drawing = false;</span>
<span class="fc" id="L154">        draw = true;</span>
<span class="fc" id="L155">        ballsOnScreen = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L156">        ballsToBeRemoved = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L157">        lines = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L158">        currentLine = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L159">    }</span>

    /**
     * Loads images required for the game.
     */
    public void loadImages() {
<span class="fc" id="L165">        ballImages = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L166">        wallImages = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L167">        holeImages = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L168">        verticalColorWallImages = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L169">        horizontalColorWallImages = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L171" title="All 2 branches covered.">        for (int i = 0; i &lt; 5; i++) {</span>
<span class="fc" id="L172">            ballImages.add(loadImage(&quot;src/main/resources/inkball/ball&quot; + i + &quot;.png&quot;));</span>
<span class="fc" id="L173">            wallImages.add(loadImage(&quot;src/main/resources/inkball/wall&quot; + i + &quot;.png&quot;));</span>
<span class="fc" id="L174">            holeImages.add(loadImage(&quot;src/main/resources/inkball/hole&quot; + i + &quot;.png&quot;));</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">            if (i != 0) {</span>
<span class="fc" id="L176">                verticalColorWallImages.add(loadImage(&quot;src/main/resources/inkball/verticalColorRestrictingWall&quot; + i + &quot;.png&quot;));</span>
<span class="fc" id="L177">                horizontalColorWallImages.add(loadImage(&quot;src/main/resources/inkball/horizontalColorRestrictingWall&quot; + i + &quot;.png&quot;));</span>
            }
        }

<span class="fc" id="L181">        normalTileImage = loadImage(&quot;src/main/resources/inkball/tile.png&quot;);</span>
<span class="fc" id="L182">        spawnerImage = loadImage(&quot;src/main/resources/inkball/entrypoint.png&quot;);</span>
<span class="fc" id="L183">    }</span>

    /**
     * Loads game configuration from a JSON file.
     *
     * @param configPath Path to the JSON configuration file.
     */
    public void loadConfig(String configPath) {
<span class="fc" id="L191">        JSONObject config = loadJSONObject(configPath);</span>

        // Load levels
<span class="fc" id="L194">        levels = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L195">        JSONArray jsonLevels = config.getJSONArray(&quot;levels&quot;);</span>
<span class="fc bfc" id="L196" title="All 2 branches covered.">        for (int i = 0; i &lt; jsonLevels.size(); i++) {</span>
<span class="fc" id="L197">            JSONObject jsonLevel = jsonLevels.getJSONObject(i);</span>
<span class="fc" id="L198">            String layout = jsonLevel.getString(&quot;layout&quot;);</span>
<span class="fc" id="L199">            int time = jsonLevel.getInt(&quot;time&quot;);</span>
<span class="fc" id="L200">            int spawnInterval = jsonLevel.getInt(&quot;spawn_interval&quot;);</span>
<span class="fc" id="L201">            float scoreIncreaseModifier = jsonLevel.getFloat(&quot;score_increase_from_hole_capture_modifier&quot;);</span>
<span class="fc" id="L202">            float scoreDecreaseModifier = jsonLevel.getFloat(&quot;score_decrease_from_wrong_hole_modifier&quot;);</span>
<span class="fc" id="L203">            List&lt;String&gt; ballsList = jsonArrayToList(jsonLevel.getJSONArray(&quot;balls&quot;));</span>

<span class="fc" id="L205">            Level level = new Level(layout, time, spawnInterval, scoreIncreaseModifier, scoreDecreaseModifier, ballsList);</span>
<span class="fc" id="L206">            levels.add(level);</span>

            // System.out.println(&quot;ScoreIncreaseModifier: &quot; + scoreIncreaseModifier);
            // System.out.println(&quot;ScoreDecreaseModifier: &quot; + scoreDecreaseModifier);
        }

        // Load score mappings
<span class="fc" id="L213">        scoreIncreaseMap = jsonToMap(config.getJSONObject(&quot;score_increase_from_hole_capture&quot;));</span>
<span class="fc" id="L214">        scoreDecreaseMap = jsonToMap(config.getJSONObject(&quot;score_decrease_from_wrong_hole&quot;));</span>

        // System.out.println(&quot;ScoreIncreaseMap: &quot; + scoreIncreaseMap);
        // System.out.println(&quot;ScoreDecreaseMap: &quot; + scoreDecreaseMap);
<span class="fc" id="L218">    }</span>

    /**
     * Converts a JSONArray to a List of Strings.
     *
     * @param jsonArray JSONArray to convert.
     * @return List of Strings.
     */
    public List&lt;String&gt; jsonArrayToList(JSONArray jsonArray) {
<span class="fc" id="L227">        List&lt;String&gt; list = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L228" title="All 2 branches covered.">        for (int i = 0; i &lt; jsonArray.size(); i++) {</span>
<span class="fc" id="L229">            list.add(jsonArray.getString(i));</span>
        }
<span class="fc" id="L231">        return list;</span>
    }

    /**
     * Converts a JSONObject to a Map of String to Integer.
     *
     * @param jsonObject JSONObject to convert.
     * @return Map of String to Integer.
     */
    public static Map&lt;String, Integer&gt; jsonToMap(JSONObject jsonObject) {
<span class="fc" id="L241">        Map&lt;String, Integer&gt; map = new HashMap&lt;&gt;();</span>
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L243">        Set&lt;String&gt; keys = jsonObject.keys();</span>
<span class="fc bfc" id="L244" title="All 2 branches covered.">        for (String key : keys) {</span>
<span class="fc" id="L245">            Integer value = jsonObject.getInt(key);</span>
<span class="fc" id="L246">            map.put(key, value);</span>
<span class="fc" id="L247">        }</span>
<span class="fc" id="L248">        return map;</span>
    }

    /**
     * Handles key pressed events.
     *
     * @param event KeyEvent.
     */
    @Override
    public void keyPressed(KeyEvent event) {
<span class="fc bfc" id="L258" title="All 2 branches covered.">        if (gameState != GameState.LEVEL_COMPLETION_ANIMATION) {</span>
<span class="fc bfc" id="L259" title="All 2 branches covered.">            if (key == ' ') {</span>
<span class="fc" id="L260">                togglePause();</span>
            }
<span class="fc bfc" id="L262" title="All 2 branches covered.">            if (key == 'r') {</span>
<span class="fc" id="L263">                restartLevel();</span>
            }
<span class="fc bfc" id="L265" title="All 2 branches covered.">            if (keyCode == CONTROL) {</span>
<span class="fc" id="L266">                ctrlPressed = true;</span>
            }
        }
<span class="fc" id="L269">    }</span>

    /**
     * Toggles the pause state of the game.
     */
    public void togglePause() {
<span class="fc bfc" id="L275" title="All 2 branches covered.">        if (gameState == GameState.RUNNING) {</span>
<span class="fc" id="L276">            gameState = GameState.PAUSED;</span>
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">        } else if (gameState == GameState.PAUSED) {</span>
<span class="fc" id="L278">            gameState = GameState.RUNNING;</span>
        }
<span class="fc" id="L280">    }</span>

    /**
     * Restarts the current level or the game.
     */
    public void restartLevel() {
<span class="fc bfc" id="L286" title="All 2 branches covered.">        if (gameState == GameState.GAME_ENDED) {</span>
<span class="fc" id="L287">            currentLevel = 1;</span>
<span class="fc" id="L288">            currentScore = 0;</span>
<span class="fc" id="L289">            previousScore = 0;</span>
        }
<span class="fc" id="L291">        lines.clear();</span>
<span class="fc" id="L292">        levelLoaded = false;</span>
<span class="fc" id="L293">        gameState = GameState.RUNNING;</span>
<span class="fc" id="L294">        levelTime = levels.get(currentLevel - 1).getTime();</span>
<span class="fc" id="L295">        currentScore = previousScore;</span>
<span class="fc" id="L296">    }</span>

    /**
     * Handles key released events.
     */
    @Override
    public void keyReleased() {
<span class="fc bfc" id="L303" title="All 2 branches covered.">        if (keyCode == CONTROL) {</span>
<span class="fc" id="L304">            ctrlPressed = false;</span>
        }
<span class="fc" id="L306">    }</span>

    /**
     * Handles mouse pressed events.
     *
     * @param event MouseEvent.
     */
    @Override
    public void mousePressed(MouseEvent event) {
<span class="pc bpc" id="L315" title="2 of 6 branches missed.">        if (mouseButton == RIGHT || (ctrlPressed &amp;&amp; mouseButton == LEFT)) {</span>
<span class="fc" id="L316">            removeLineAtMouse();</span>
        }
<span class="fc" id="L318">    }</span>

    /**
     * Removes a line if the mouse position collides with the line.
     */
    public void removeLineAtMouse() {
<span class="fc" id="L324">        float tolerance = 5; // Tolerance distance for removing the line</span>

        // Check each line to see if the mouse is near any segment
<span class="fc" id="L327">        Iterator&lt;List&lt;PVector&gt;&gt; iterator = lines.iterator();</span>
<span class="fc bfc" id="L328" title="All 2 branches covered.">        while (iterator.hasNext()) {</span>
<span class="fc" id="L329">            List&lt;PVector&gt; line = iterator.next();</span>
<span class="fc bfc" id="L330" title="All 2 branches covered.">            for (int i = 1; i &lt; line.size(); i++) {</span>
<span class="fc" id="L331">                PVector start = line.get(i - 1);</span>
<span class="fc" id="L332">                PVector end = line.get(i);</span>

<span class="fc bfc" id="L334" title="All 2 branches covered.">                if (isMouseNearLine(start, end, tolerance)) {</span>
<span class="fc" id="L335">                    iterator.remove();</span>
<span class="fc" id="L336">                    return;</span>
                }
            }
<span class="fc" id="L339">        }</span>
<span class="fc" id="L340">    }</span>

    /**
     * Checks if the mouse position is near a line segment.
     *
     * @param start     Start point of the line segment.
     * @param end       End point of the line segment.
     * @param tolerance Tolerance distance.
     * @return True if near, false otherwise.
     */
    public boolean isMouseNearLine(PVector start, PVector end, float tolerance) {
<span class="fc" id="L351">        PVector mousePos = new PVector(mouseX, mouseY - TOP_BAR_HEIGHT);</span>
<span class="fc" id="L352">        float distance = distPointToSegment(mousePos, start, end);</span>
<span class="fc bfc" id="L353" title="All 2 branches covered.">        return distance &lt; tolerance;</span>
    }

    /**
     * Calculates the distance from a point to a line segment.
     *
     * @param p Point.
     * @param v Line segment start.
     * @param w Line segment end.
     * @return Distance.
     */
    public static float distPointToSegment(PVector p, PVector v, PVector w) {
<span class="fc" id="L365">        float l2 = v.dist(w) * v.dist(w);</span>
<span class="fc bfc" id="L366" title="All 2 branches covered.">        if (l2 == 0.0) return p.dist(v);</span>
<span class="fc" id="L367">        float t = Math.max(0, Math.min(1, PVector.sub(p, v).dot(PVector.sub(w, v)) / l2));</span>
<span class="fc" id="L368">        PVector projection = PVector.add(v, PVector.sub(w, v).mult(t));</span>
<span class="fc" id="L369">        return p.dist(projection);</span>
    }

    public PImage getBallImage(int color) {
<span class="fc" id="L373">        return ballImages.get(color);</span>
    }

    public void addBallToRemove(Ball ball) {
<span class="fc" id="L377">        ballsToBeRemoved.add(ball);</span>
<span class="fc" id="L378">    }</span>
    
    public void increaseScore(int amount) {
<span class="fc" id="L381">        currentScore += amount;</span>
<span class="fc" id="L382">    }</span>
    
    public void decreaseScore(int amount) {
<span class="fc" id="L385">        currentScore = Math.max(0, currentScore - amount);</span>
<span class="fc" id="L386">    }</span>
    
    public void addBallToQueue(String ballColorName) {
<span class="fc" id="L389">        ballsInQueue.add(ballColorName);</span>
<span class="fc" id="L390">    }</span>
    
    public float getScoreIncreaseModifier() {
<span class="fc" id="L393">        return scoreIncreaseModifier;</span>
    }
    
    public float getScoreDecreaseModifier() {
<span class="fc" id="L397">        return scoreDecreaseModifier;</span>
    }
    
    public Map&lt;String, Integer&gt; getScoreIncreaseMap() {
<span class="fc" id="L401">        return scoreIncreaseMap;</span>
    }
    
    public Map&lt;String, Integer&gt; getScoreDecreaseMap() {
<span class="fc" id="L405">        return scoreDecreaseMap;</span>
    }

    // public static void setScoreIncreaseMap(Map&lt;String, Integer&gt; scoreIncreaseMap) {
    //     App.scoreIncreaseMap = scoreIncreaseMap;
    // }
    
    // public static void setScoreDecreaseMap(Map&lt;String, Integer&gt; scoreDecreaseMap) {
    //     App.scoreDecreaseMap = scoreDecreaseMap;
    // }

    // public int getCurrentScore() { return currentScore; }

<span class="fc" id="L418">    public List&lt;Ball&gt; getBallsToBeRemoved() { return ballsToBeRemoved; }</span>

    /**
     * Handles mouse dragged events.
     *
     * @param event MouseEvent.
     */
    @Override
    public void mouseDragged(MouseEvent event) {
<span class="pc bpc" id="L427" title="1 of 2 branches missed.">        if (mouseButton == LEFT) {</span>
<span class="pc bpc" id="L428" title="3 of 4 branches missed.">            if (gameState == GameState.RUNNING || gameState == GameState.PAUSED) {</span>
<span class="fc" id="L429">                drawing = true;</span>
<span class="fc" id="L430">                currentLine.add(new PVector(mouseX, mouseY - TOP_BAR_HEIGHT));</span>
            }
        }
<span class="fc" id="L433">    }</span>

    /**
     * Handles mouse released events.
     *
     * @param event MouseEvent.
     */
    @Override
    public void mouseReleased(MouseEvent event) {
<span class="pc bpc" id="L442" title="1 of 2 branches missed.">        if (mouseButton == LEFT) {</span>
<span class="pc bpc" id="L443" title="1 of 2 branches missed.">            if (!currentLine.isEmpty()) {</span>
<span class="fc" id="L444">                lines.add(new ArrayList&lt;&gt;(currentLine));</span>
<span class="fc" id="L445">                currentLine.clear();</span>
            }
<span class="fc" id="L447">            drawing = false;</span>
        }
<span class="fc" id="L449">    }</span>

    /**
     * The main game loop logic.
     */
    public void tick() {
<span class="fc bfc" id="L455" title="All 2 branches covered.">        if (!levelLoaded) {</span>
<span class="fc" id="L456">            loadLevel(currentLevel);</span>
        }

<span class="pc bpc" id="L459" title="1 of 5 branches missed.">        switch (gameState) {</span>
            case RUNNING:
<span class="fc" id="L461">                updateGame();</span>
<span class="fc" id="L462">                break;</span>
            case LEVEL_COMPLETION_ANIMATION:
<span class="fc" id="L464">                playLevelCompletionAnimation();</span>
<span class="fc" id="L465">                break;</span>
            case LEVEL_COMPLETE:
<span class="fc" id="L467">                advanceLevel();</span>
<span class="fc" id="L468">                break;</span>
            case GAME_ENDED:
<span class="fc" id="L470">                resetGame();</span>
<span class="fc" id="L471">                break;</span>
            default:
                break;
        }

<span class="fc" id="L476">        drawTopBarLayer();</span>
<span class="fc" id="L477">        drawLineLayer();</span>
<span class="fc" id="L478">    }</span>

    /**
     * Updates the game state when running.
     */
    public void updateGame() {
<span class="fc bfc" id="L484" title="All 4 branches covered.">        if (ballsOnScreen.isEmpty() &amp;&amp; ballsInQueue.isEmpty()) {</span>
<span class="fc" id="L485">            drawBallLayer(); // clear ball layer (otherwise last ball to fall in hole will freeze on screen)</span>
<span class="fc" id="L486">            image(ballLayer, 0, TOP_BAR_HEIGHT);</span>
<span class="fc" id="L487">            gameState = GameState.LEVEL_COMPLETION_ANIMATION;</span>
        } else {
<span class="fc" id="L489">            updateTime();</span>
<span class="fc" id="L490">            drawBallLayer();</span>
<span class="fc" id="L491">            drawConveyorBeltLayer();</span>
        }
<span class="fc" id="L493">    }</span>

    /**
     * Plays the level completion animation.
     */
    public void playLevelCompletionAnimation() {

<span class="fc bfc" id="L500" title="All 2 branches covered.">        if (levelTime &gt; 0) {</span>
<span class="fc bfc" id="L501" title="All 2 branches covered.">            if (draw) {</span>
<span class="fc" id="L502">                drawLevelCompletionLayer();</span>
            }
<span class="fc bfc" id="L504" title="All 2 branches covered.">            draw = !draw;</span>
        } else {
<span class="fc" id="L506">            gameState = GameState.LEVEL_COMPLETE;</span>
        }
<span class="fc" id="L508">    }</span>

    /**
     * Advances to the next level or ends the game if last level.
     */
    public void advanceLevel() {
<span class="fc bfc" id="L514" title="All 2 branches covered.">        if (currentLevel &lt; levels.size()) {</span>
<span class="fc" id="L515">            currentLevel++;</span>
<span class="fc" id="L516">            levelLoaded = false;</span>
<span class="fc" id="L517">            gameState = GameState.RUNNING;</span>
<span class="fc" id="L518">            previousScore = currentScore;</span>
<span class="fc" id="L519">            lines.clear();</span>
        } else {
<span class="fc" id="L521">            gameState = GameState.GAME_ENDED;</span>
        }
<span class="fc" id="L523">    }</span>

    /**
     * Resets the game after it has ended.
     */
    public void resetGame() {
<span class="fc" id="L529">        drawBallLayer(); // clear ball layer (otherwise last ball to fall in hole will freeze on screen)</span>
<span class="fc" id="L530">        image(ballLayer, 0, TOP_BAR_HEIGHT);</span>

<span class="fc" id="L532">        lines.clear();</span>
<span class="fc" id="L533">    }</span>

    /**
     * Updates the level time and spawn time.
     */
    public void updateTime() {
<span class="fc" id="L539">        levelFrames--;</span>
<span class="fc" id="L540">        levelTime = levelFrames / FPS;</span>
<span class="fc" id="L541">        spawnFrames--;</span>
<span class="fc" id="L542">        spawnTime = (float) Math.ceil(spawnFrames / 3) / 10.0f;</span>

<span class="pc bpc" id="L544" title="1 of 2 branches missed.">        if (levelFrames == 0) {</span>
<span class="nc" id="L545">            gameState = GameState.LEVEL_TIME_UP;</span>
        }
<span class="fc" id="L547">    }</span>

<span class="fc" id="L549">    int tile1Row = 1;</span>
<span class="fc" id="L550">    int tile1Column = 0;</span>
<span class="fc" id="L551">    int xDirection = 0;</span>
<span class="fc" id="L552">    int yDirection = -1;</span>

    /**
     * Draws the level completion layer.
     *
     * @return True if drawing occurs, false otherwise.
     */
    public boolean drawLevelCompletionLayer() {
<span class="fc" id="L560">        levelCompletionLayer.beginDraw();</span>
<span class="fc" id="L561">        levelCompletionLayer.clear();</span>

<span class="fc" id="L563">        tile1Row += yDirection;</span>
<span class="fc" id="L564">        tile1Column += xDirection;</span>
<span class="fc" id="L565">        int tile2Row = (BOARD_SIZE-1) - tile1Row;</span>
<span class="fc" id="L566">        int tile2Column = (BOARD_SIZE-1) - tile1Column;</span>
<span class="fc bfc" id="L567" title="All 4 branches covered.">        if (tile1Row == 0 &amp;&amp; tile1Column == 0) { // tile 1 reaches top left corner</span>
<span class="fc" id="L568">            yDirection = 0;</span>
<span class="fc" id="L569">            xDirection = 1;</span>
        }
<span class="fc bfc" id="L571" title="All 4 branches covered.">        if (tile1Row == 0 &amp;&amp; tile1Column == 17) { // tile 1 reaches top right corner</span>
<span class="fc" id="L572">            yDirection = 1;</span>
<span class="fc" id="L573">            xDirection = 0;</span>
        }
<span class="fc bfc" id="L575" title="All 4 branches covered.">        if (tile1Row == 17 &amp;&amp; tile1Column == 17) { // tile 1 reaches bottom right corner</span>
<span class="fc" id="L576">            yDirection = 0;</span>
<span class="fc" id="L577">            xDirection = -1;</span>
        }
<span class="fc bfc" id="L579" title="All 4 branches covered.">        if (tile1Row == 17 &amp;&amp; tile1Column == 0) { // tile 1 reaches bottom left corner</span>
<span class="fc" id="L580">            yDirection = -1;</span>
<span class="fc" id="L581">            xDirection = 0;</span>
        }

<span class="fc" id="L584">        int tile1X = tile1Column*CELL_SIZE;</span>
<span class="fc" id="L585">        int tile1Y = tile1Row*CELL_SIZE;</span>
<span class="fc" id="L586">        int tile2X = tile2Column*CELL_SIZE;</span>
<span class="fc" id="L587">        int tile2Y = tile2Row*CELL_SIZE;</span>

<span class="fc" id="L589">        levelCompletionLayer.image(wallImages.get(4), tile1X, tile1Y);</span>
<span class="fc" id="L590">        levelCompletionLayer.image(wallImages.get(4), tile2X, tile2Y);</span>

<span class="fc" id="L592">        levelTime--;</span>
<span class="fc" id="L593">        currentScore++;</span>

<span class="fc" id="L595">        levelCompletionLayer.endDraw();</span>

<span class="pc bpc" id="L597" title="1 of 2 branches missed.">        return !draw;</span>
    }


    /**
     * Draws the line layer.
     */
    public void drawLineLayer() {
<span class="fc" id="L605">        lineLayer.beginDraw();</span>
<span class="fc" id="L606">        lineLayer.clear();</span>
<span class="fc" id="L607">        lineLayer.stroke(0);</span>
<span class="fc" id="L608">        lineLayer.strokeWeight(10);</span>

<span class="fc" id="L610">        List&lt;List&lt;PVector&gt;&gt; linesToBeRemoved = new ArrayList&lt;&gt;();</span>

        // Draw existing lines
<span class="fc bfc" id="L613" title="All 2 branches covered.">        for (List&lt;PVector&gt; line : lines) {</span>
<span class="fc bfc" id="L614" title="All 2 branches covered.">            for (int i = 1; i &lt; line.size(); i++) {</span>
<span class="fc" id="L615">                PVector start = line.get(i - 1);</span>
<span class="fc" id="L616">                PVector end = line.get(i);</span>
<span class="fc" id="L617">                lineLayer.line(start.x, start.y, end.x, end.y);</span>
<span class="fc bfc" id="L618" title="All 2 branches covered.">                if (gameState == GameState.RUNNING) {</span>
<span class="fc bfc" id="L619" title="All 2 branches covered.">                    for (Ball ball : ballsOnScreen) {</span>
<span class="fc bfc" id="L620" title="All 2 branches covered.">                        if (ball.handleCollisionWithLine(start, end)) {</span>
<span class="fc" id="L621">                            linesToBeRemoved.add(line);</span>
<span class="fc" id="L622">                            break;</span>
                        }
<span class="fc" id="L624">                    }</span>
                }
            }
<span class="fc" id="L627">        }</span>

<span class="fc bfc" id="L629" title="All 2 branches covered.">        for (List&lt;PVector&gt; line : linesToBeRemoved) {</span>
<span class="fc" id="L630">            lines.remove(line);</span>
<span class="fc" id="L631">        }</span>

        // Draw the current line being drawn
<span class="fc bfc" id="L634" title="All 4 branches covered.">        if (drawing &amp;&amp; currentLine.size() &gt; 1) {</span>
<span class="fc bfc" id="L635" title="All 2 branches covered.">            for (int i = 1; i &lt; currentLine.size(); i++) {</span>
<span class="fc" id="L636">                PVector start = currentLine.get(i - 1);</span>
<span class="fc" id="L637">                PVector end = currentLine.get(i);</span>
<span class="fc" id="L638">                lineLayer.line(start.x, start.y, end.x, end.y);</span>
            }
        }

<span class="fc" id="L642">        lineLayer.endDraw();</span>
<span class="fc" id="L643">    }</span>

    /**
     * Draws the top bar layer.
     */
    public void drawTopBarLayer() {
<span class="fc" id="L649">        topBarLayer.beginDraw();</span>
<span class="fc" id="L650">        topBarLayer.background(204);</span>

<span class="fc" id="L652">        topBarLayer.fill(0);</span>
<span class="fc" id="L653">        topBarLayer.textSize(20);</span>
<span class="fc" id="L654">        topBarLayer.text(&quot;Score: &quot; + currentScore, WIDTH - 120, 25);</span>
<span class="fc" id="L655">        topBarLayer.text(&quot;Time: &quot; + levelTime, WIDTH - 120, 50);</span>

<span class="fc bfc" id="L657" title="All 2 branches covered.">        if (!ballsInQueue.isEmpty()) {</span>
<span class="fc" id="L658">            topBarLayer.text(String.format(&quot;%.1f&quot;, spawnTime), 190, 35);</span>
        }

<span class="fc bfc" id="L661" title="All 4 branches covered.">        switch (gameState) {</span>
            case GAME_ENDED:
<span class="fc" id="L663">                topBarLayer.text(&quot;=== GAME ENDED ===&quot;, 200, 35);</span>
<span class="fc" id="L664">                break;</span>
            case LEVEL_TIME_UP:
<span class="fc" id="L666">                topBarLayer.text(&quot;=== TIME’S UP ===&quot;, 200, 35);</span>
<span class="fc" id="L667">                break;</span>
            case PAUSED:
<span class="fc" id="L669">                topBarLayer.text(&quot;*** PAUSED ***&quot;, 240, 35);</span>
<span class="fc" id="L670">                break;</span>
            default:
                break;
        }

<span class="fc" id="L675">        topBarLayer.endDraw();</span>
<span class="fc" id="L676">    }</span>

<span class="fc" id="L678">    int horizontalOffset = 0;</span>

    /**
     * Draws the ball layer.
     */
    public void drawBallLayer() {
<span class="fc" id="L684">        ballLayer.beginDraw();</span>
<span class="fc" id="L685">        ballLayer.clear();</span>

<span class="fc" id="L687">        ballsToBeRemoved.clear();</span>
<span class="fc bfc" id="L688" title="All 2 branches covered.">        for (Ball ball : ballsOnScreen) {</span>
<span class="fc" id="L689">            ball.checkSurrounding(board);</span>
<span class="fc" id="L690">            ball.updatePosition();</span>
<span class="fc" id="L691">            ballLayer.image(ball.getImage(), ball.getCenterXPosition() - Ball.RADIUS, ball.getCenterYPosition() - Ball.RADIUS);</span>
<span class="fc" id="L692">        }</span>

<span class="fc" id="L694">        ballsOnScreen.removeAll(ballsToBeRemoved);</span>

<span class="fc" id="L696">        ballLayer.endDraw();</span>
<span class="fc" id="L697">    }</span>

    /**
     * Draws the conveyor belt layer.
     */
    public void drawConveyorBeltLayer() {
<span class="fc" id="L703">        conveyorBeltLayer.beginDraw();</span>
<span class="fc" id="L704">        conveyorBeltLayer.background(0);</span>

<span class="fc" id="L706">        int ballVerticalOffset = (conveyorBeltLayer.height - 2 * Ball.RADIUS) / 2;</span>
<span class="fc" id="L707">        int spaceBetweenBalls = (conveyorBeltLayer.width - (5 * 2 * Ball.RADIUS)) / 6;</span>

<span class="fc bfc" id="L709" title="All 2 branches covered.">        if (spawnFrames == 0) {</span>
<span class="fc" id="L710">            spawnFrames = FPS * spawnInterval;</span>
<span class="fc" id="L711">            horizontalOffset = spaceBetweenBalls+2*Ball.RADIUS;</span>
<span class="fc bfc" id="L712" title="All 2 branches covered.">            if (!ballsInQueue.isEmpty()) {</span>
<span class="fc" id="L713">                String ballColor = ballsInQueue.poll();</span>
<span class="fc" id="L714">                Spawner spawner = spawners.get(RANDOM.nextInt(spawners.size()));</span>
<span class="fc" id="L715">                float centerX = spawner.getCenterXPosition();</span>
<span class="fc" id="L716">                float centerY = spawner.getCenterYPosition();</span>
<span class="fc" id="L717">                int color = ColorCode.getValue(ballColor);</span>
<span class="fc" id="L718">                Ball ball = new Ball(centerX, centerY, color, ballImages.get(color));</span>
<span class="fc" id="L719">                ballsOnScreen.add(ball);</span>
            }
        }

<span class="fc" id="L723">        Iterator&lt;String&gt; iterator = ballsInQueue.iterator();</span>
<span class="fc" id="L724">        int count = 0;</span>

<span class="fc bfc" id="L726" title="All 4 branches covered.">        while (iterator.hasNext() &amp;&amp; count &lt; 5) {</span>
<span class="fc" id="L727">            String ballColor = iterator.next();</span>
<span class="fc" id="L728">            int ballHorizontalOffset = horizontalOffset + (count + 1) * spaceBetweenBalls + count * 2 * Ball.RADIUS;</span>
<span class="fc" id="L729">            conveyorBeltLayer.image(ballImages.get(ColorCode.getValue(ballColor)), ballHorizontalOffset, ballVerticalOffset);</span>
<span class="fc" id="L730">            count++;</span>
<span class="fc" id="L731">        }</span>

<span class="fc bfc" id="L733" title="All 2 branches covered.">        if (horizontalOffset &gt; 0) {</span>
<span class="fc" id="L734">            horizontalOffset--;</span>
        }

<span class="fc" id="L737">        conveyorBeltLayer.endDraw();</span>
<span class="fc" id="L738">    }</span>

    /**
     * Loads a level based on the current level number.
     *
     * @param levelNumber The current level number.
     */
    public void loadLevel(int levelNumber) {
<span class="fc" id="L746">        Level level = levels.get(levelNumber - 1);</span>

<span class="fc" id="L748">        layout = level.getLayout();</span>
<span class="fc" id="L749">        loadLayout(layout);</span>

<span class="fc" id="L751">        levelTime = level.getTime();</span>
<span class="fc" id="L752">        levelFrames = levelTime * FPS;</span>
<span class="fc" id="L753">        spawnInterval = level.getSpawnInterval();</span>
<span class="fc" id="L754">        spawnTime = spawnInterval;</span>
<span class="fc" id="L755">        spawnFrames = (int) spawnTime * FPS;</span>

<span class="fc" id="L757">        scoreIncreaseModifier = level.getScoreIncreaseModifier();</span>
<span class="fc" id="L758">        scoreDecreaseModifier = level.getScoreDecreaseModifier();</span>
<span class="fc" id="L759">        ballsInQueue = new ArrayDeque&lt;&gt;(level.getBalls());</span>

<span class="fc" id="L761">        levelLoaded = true;</span>
<span class="fc" id="L762">        gameState = GameState.RUNNING;</span>
<span class="fc" id="L763">    }</span>

    /**
     * Loads the layout from a file.
     *
     * @param layoutFile The layout file.
     */
    public void loadLayout(String layoutFile) {
<span class="fc" id="L771">        board = new Tile[BOARD_SIZE][BOARD_SIZE];</span>
<span class="fc" id="L772">        ballsOnScreen = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L773">        spawners = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L775">        boardLayer.beginDraw();</span>

<span class="fc" id="L777">        BufferedReader reader = null;</span>
        try {
<span class="fc" id="L779">            reader = new BufferedReader(new FileReader(layoutFile));</span>
            String line;
<span class="fc" id="L781">            int row = 0;</span>

<span class="pc bpc" id="L783" title="1 of 4 branches missed.">            while ((line = reader.readLine()) != null &amp;&amp; row &lt; BOARD_SIZE) {</span>
<span class="pc bpc" id="L784" title="1 of 4 branches missed.">                for (int column = 0; column &lt; BOARD_SIZE &amp;&amp; column &lt; line.length(); column++) {</span>
<span class="fc" id="L785">                    char c = line.charAt(column);</span>
<span class="fc" id="L786">                    int xPosition = column * CELL_SIZE;</span>
<span class="fc" id="L787">                    int yPosition = row * CELL_SIZE;</span>
<span class="fc" id="L788">                    int centerXPosition = column * CELL_SIZE + CELL_SIZE / 2;</span>
<span class="fc" id="L789">                    int centerYPosition = row * CELL_SIZE + CELL_SIZE / 2;</span>
                    int color;

<span class="fc bfc" id="L792" title="All 12 branches covered.">                    switch(c) {</span>
                        case 'X':
<span class="fc" id="L794">                            color = 0;</span>
<span class="fc" id="L795">                            board[row][column] = new Wall(centerXPosition, centerYPosition, color);</span>
<span class="fc" id="L796">                            boardLayer.image(wallImages.get(color), xPosition, yPosition);</span>
<span class="fc" id="L797">                            break;</span>
                        case '1':
<span class="fc" id="L799">                            color = 1;</span>
<span class="fc" id="L800">                            board[row][column] = new Wall(centerXPosition, centerYPosition, color);</span>
<span class="fc" id="L801">                            boardLayer.image(wallImages.get(color), xPosition, yPosition);</span>
<span class="fc" id="L802">                            break;</span>
                        case '2':
<span class="fc" id="L804">                            color = 2;</span>
<span class="fc" id="L805">                            board[row][column] = new Wall(centerXPosition, centerYPosition, color);</span>
<span class="fc" id="L806">                            boardLayer.image(wallImages.get(color), xPosition, yPosition);</span>
<span class="fc" id="L807">                            break;</span>
                        case '3':
<span class="fc" id="L809">                            color = 3;</span>
<span class="fc" id="L810">                            board[row][column] = new Wall(centerXPosition, centerYPosition, color);</span>
<span class="fc" id="L811">                            boardLayer.image(wallImages.get(color), xPosition, yPosition);</span>
<span class="fc" id="L812">                            break;</span>
                        case '4':
<span class="fc" id="L814">                            color = 4;</span>
<span class="fc" id="L815">                            board[row][column] = new Wall(centerXPosition, centerYPosition, color);</span>
<span class="fc" id="L816">                            boardLayer.image(wallImages.get(color), xPosition, yPosition);</span>
<span class="fc" id="L817">                            break;</span>
                        case 'V':
<span class="fc" id="L819">                            color = line.charAt(column + 1) - '0';</span>
<span class="pc bpc" id="L820" title="1 of 4 branches missed.">                            if (color &gt; 4 || color &lt; 0) {</span>
<span class="fc" id="L821">                                return;</span>
                            }
<span class="fc" id="L823">                            centerXPosition = column * CELL_SIZE + Wall.HALF_SIZE;</span>
<span class="fc" id="L824">                            centerYPosition = row * CELL_SIZE + Wall.HALF_SIZE;</span>
<span class="fc" id="L825">                            ColorRestrictingWall verticalColorRestrictingWall = new ColorRestrictingWall(centerXPosition, centerYPosition, color, true);</span>
<span class="fc" id="L826">                            board[row][column] = verticalColorRestrictingWall;</span>
<span class="fc" id="L827">                            boardLayer.image(verticalColorWallImages.get(color-1), xPosition, yPosition);</span>
<span class="fc" id="L828">                            column++; // Skip the color character</span>
<span class="fc" id="L829">                            xPosition = column * CELL_SIZE;</span>
<span class="fc" id="L830">                            boardLayer.image(normalTileImage, xPosition, yPosition);</span>
<span class="fc" id="L831">                            break;</span>
                        case 'Z':
<span class="fc" id="L833">                            int offset = column;</span>
<span class="pc bpc" id="L834" title="2 of 4 branches missed.">                            while (line.charAt(offset + 1) - '0' &gt; 9 || line.charAt(offset + 1) - '0' &lt; 0) { // next char is not color</span>
<span class="nc" id="L835">                                offset++;</span>
                            }
<span class="fc" id="L837">                            color = line.charAt(offset + 1) - '0';</span>
<span class="fc" id="L838">                            centerXPosition = column * CELL_SIZE + Wall.HALF_SIZE;</span>
<span class="fc" id="L839">                            centerYPosition = row * CELL_SIZE + Wall.HALF_SIZE;</span>
<span class="fc" id="L840">                            ColorRestrictingWall horizontalColorRestrictingWall = new ColorRestrictingWall(centerXPosition, centerYPosition, color, false);</span>
<span class="fc" id="L841">                            board[row][column] = horizontalColorRestrictingWall;</span>
<span class="fc" id="L842">                            boardLayer.image(horizontalColorWallImages.get(color-1), xPosition, yPosition);</span>
<span class="pc bpc" id="L843" title="1 of 2 branches missed.">                            if (offset == column) { // next char is color</span>
<span class="fc" id="L844">                                column++;</span>
<span class="fc" id="L845">                                xPosition = column * CELL_SIZE;</span>
<span class="fc" id="L846">                                boardLayer.image(normalTileImage, xPosition, yPosition);</span>
                            }
                            break;
                        case ' ':
<span class="fc bfc" id="L850" title="All 2 branches covered.">                            if (board[row][column] == null) {</span>
<span class="fc" id="L851">                                boardLayer.image(normalTileImage, xPosition, yPosition);</span>
                            }
                            break;
                        case 'S':
<span class="fc" id="L855">                            Spawner spawner = new Spawner(centerXPosition, centerYPosition);</span>
<span class="fc" id="L856">                            spawners.add(spawner);</span>
<span class="fc" id="L857">                            board[row][column] = spawner;</span>
<span class="fc" id="L858">                            boardLayer.image(spawnerImage, xPosition, yPosition);</span>
<span class="fc" id="L859">                            break;</span>
                        case 'H':
<span class="fc" id="L861">                            color = line.charAt(column + 1) - '0';</span>
<span class="fc" id="L862">                            centerXPosition = column * CELL_SIZE + Hole.HALF_SIZE;</span>
<span class="fc" id="L863">                            centerYPosition = row * CELL_SIZE + Hole.HALF_SIZE;</span>
<span class="fc" id="L864">                            Hole hole = new Hole(centerXPosition, centerYPosition, color);</span>
<span class="fc" id="L865">                            boardLayer.image(holeImages.get(color), xPosition, yPosition);</span>
<span class="fc" id="L866">                            board[row][column] = hole;</span>
<span class="fc" id="L867">                            board[row][column + 1] = hole;</span>
<span class="fc" id="L868">                            board[row + 1][column] = hole;</span>
<span class="fc" id="L869">                            board[row + 1][column + 1] = hole;</span>
<span class="fc" id="L870">                            column++; // Skip the color character</span>
<span class="fc" id="L871">                            break;</span>
                        case 'B':
<span class="fc" id="L873">                            color = line.charAt(column + 1) - '0';</span>
<span class="fc" id="L874">                            ballsOnScreen.add(new Ball(centerXPosition, centerYPosition, color, ballImages.get(color)));</span>
<span class="fc" id="L875">                            boardLayer.image(normalTileImage, xPosition, yPosition);</span>
<span class="fc" id="L876">                            column++; // Skip the color character</span>
<span class="fc" id="L877">                            xPosition = column * CELL_SIZE;</span>
<span class="fc" id="L878">                            boardLayer.image(normalTileImage, xPosition, yPosition);</span>
                            break;
                    }

                }
<span class="fc" id="L883">                row++;</span>
            }
<span class="fc" id="L885">        } catch (FileNotFoundException e) {</span>
<span class="fc" id="L886">            System.err.println(&quot;File not found: &quot; + layoutFile);</span>
            // e.printStackTrace();
<span class="nc" id="L888">        } catch (IOException e) {</span>
<span class="nc" id="L889">            System.err.println(&quot;Error reading the file: &quot; + layoutFile);</span>
            // e.printStackTrace();
<span class="nc" id="L891">        } catch (Exception e) {</span>
<span class="nc" id="L892">            System.err.println(&quot;An unexpected error occurred.&quot;);</span>
<span class="nc" id="L893">            e.printStackTrace();</span>
        } finally {
            try {
<span class="fc bfc" id="L896" title="All 2 branches covered.">                if (reader != null) {</span>
<span class="fc" id="L897">                    reader.close();</span>
                }
<span class="nc" id="L899">            } catch (IOException e) {</span>
                // Handle potential IOException from reader.close()
<span class="nc" id="L901">                e.printStackTrace();</span>
<span class="fc" id="L902">            }</span>
        }

<span class="fc" id="L905">        boardLayer.endDraw();</span>
<span class="fc" id="L906">    }</span>

    /**
     * Draws all elements in the game by current frame.
     */
    @Override
    public void draw() {
<span class="fc" id="L913">        tick();</span>

<span class="fc" id="L915">        image(boardLayer, 0, TOP_BAR_HEIGHT);</span>
<span class="fc bfc" id="L916" title="All 2 branches covered.">        if (gameState == GameState.LEVEL_COMPLETION_ANIMATION) {</span>
<span class="fc" id="L917">            image(levelCompletionLayer, 0, TOP_BAR_HEIGHT);</span>
        }
<span class="fc" id="L919">        image(ballLayer, 0, TOP_BAR_HEIGHT);</span>
<span class="fc" id="L920">        image(lineLayer, 0, TOP_BAR_HEIGHT);</span>
<span class="fc" id="L921">        image(topBarLayer, 0, 0);</span>
<span class="fc" id="L922">        image(conveyorBeltLayer, 10, 10);</span>
<span class="fc" id="L923">    }</span>

    /**
     * Main method to start the application.
     *
     * @param args Command line arguments.
     */
    public static void main(String[] args) {
<span class="fc" id="L931">        PApplet.main(&quot;inkball.App&quot;);</span>
<span class="fc" id="L932">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>